name: Validate and Deploy HTML

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate HTML File
      run: |
        echo "Validando arquivo HTML..."
        
        # Verificar se o arquivo existe
        if [ ! -f "ondemand-dev-site.html" ]; then
          echo "âŒ Arquivo ondemand-dev-site.html nÃ£o encontrado!"
          exit 1
        fi
        
        # Verificar se contÃ©m cÃ³digo Umami
        if grep -q "analytics.ondemandev.com.br" ondemand-dev-site.html; then
          echo "âœ… CÃ³digo Umami Analytics encontrado"
        else
          echo "âŒ CÃ³digo Umami Analytics NÃƒO encontrado!"
          exit 1
        fi
        
        # Verificar Website ID
        if grep -q "e7068192-2723-4b79-8a67-b60543184d2d" ondemand-dev-site.html; then
          echo "âœ… Website ID correto encontrado"
        else
          echo "âŒ Website ID incorreto ou nÃ£o encontrado!"
          exit 1
        fi
        
        echo "âœ… HTML vÃ¡lido e pronto para deploy!"

  deploy:
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
    
    - name: Deploy to K3s via API
      run: |
        echo "ğŸš€ Iniciando deploy via K3s API..."
        
        # Verificar se as secrets estÃ£o configuradas
        echo "ğŸ” Verificando secrets..."
        if [ -z "${{ secrets.K3S_API_URL }}" ]; then
          echo "âŒ K3S_API_URL nÃ£o configurada!"
          exit 1
        fi
        if [ -z "${{ secrets.K3S_CA_CERT }}" ]; then
          echo "âŒ K3S_CA_CERT nÃ£o configurada!"
          exit 1
        fi
        if [ -z "${{ secrets.K3S_TOKEN }}" ]; then
          echo "âŒ K3S_TOKEN nÃ£o configurada!"
          exit 1
        fi
        echo "âœ… Todas as secrets estÃ£o configuradas"
        
        # Mostrar valores mascarados para debug (apenas primeiros chars)
        echo "ğŸ” API URL: ${{ secrets.K3S_API_URL }}"
        echo "ğŸ” CA Cert (primeiros 50 chars): $(echo '${{ secrets.K3S_CA_CERT }}' | cut -c1-50)..."
        echo "ğŸ” Token (primeiros 20 chars): $(echo '${{ secrets.K3S_TOKEN }}' | cut -c1-20)..."
        
        # Configurar kubectl com certificado e token
        echo "ğŸ“„ Decodificando certificado CA..."
        echo "${{ secrets.K3S_CA_CERT }}" | base64 -d > ca.crt
        
        # Verificar se o certificado foi decodificado corretamente
        if [ ! -s ca.crt ]; then
          echo "âŒ Erro ao decodificar certificado CA!"
          exit 1
        fi
        echo "âœ… Certificado CA decodificado com sucesso"
        
        # Limpar configuraÃ§Ã£o existente
        rm -f ~/.kube/config
        mkdir -p ~/.kube
        
        # Configurar cluster com verificaÃ§Ã£o
        echo "âš™ï¸ Configurando cluster..."
        kubectl config set-cluster k3s-cluster \
          --server="${{ secrets.K3S_API_URL }}" \
          --certificate-authority=ca.crt \
          --embed-certs=true
        
        # Configurar usuÃ¡rio
        kubectl config set-credentials k3s-user \
          --token=${{ secrets.K3S_TOKEN }}
        
        # Configurar contexto
        kubectl config set-context k3s-context \
          --cluster=k3s-cluster \
          --user=k3s-user
        
        # Usar o contexto
        kubectl config use-context k3s-context
        
        # Verificar configuraÃ§Ã£o
        echo "ğŸ”§ Verificando configuraÃ§Ã£o kubectl..."
        kubectl config current-context
        kubectl config view --minify
        
        # Verificar conectividade
        echo "ğŸ” Testando conectividade com K3s..."
        kubectl get nodes --insecure-skip-tls-verify=false
        
        # Criar ConfigMap com o HTML atualizado
        echo "ğŸ“„ Atualizando ConfigMap frontend-html..."
        kubectl create configmap frontend-html \
          --from-file=ondemand-dev-site.html \
          -n default \
          --dry-run=client -o yaml | kubectl apply -f -
        
        # Reiniciar deployment para aplicar mudanÃ§as
        echo "ğŸ”„ Reiniciando deployment frontend..."
        kubectl rollout restart deployment/frontend-deployment -n default
        
        # Aguardar deployment ficar pronto
        echo "â³ Aguardando deployment ficar pronto..."
        kubectl rollout status deployment/frontend-deployment -n default --timeout=300s
        
        # Verificar pods
        echo "ğŸ“Š Status dos pods:"
        kubectl get pods -n default | grep frontend-deployment
        
        # Aguardar um pouco e testar o site
        echo "ğŸ§ª Testando site..."
        sleep 30
        
        # Testar se o site estÃ¡ funcionando
        if curl -s --max-time 30 https://ondemandev.com.br | grep -q "analytics.ondemandev.com.br"; then
          echo "âœ… Deploy bem-sucedido! Umami Analytics detectado no site"
          echo "ğŸŒ Site disponÃ­vel em: https://ondemandev.com.br"
          echo "ğŸ“Š Analytics em: https://analytics.ondemandev.com.br"
        else
          echo "âŒ Problema no deploy - Umami nÃ£o encontrado ou site nÃ£o responde"
          exit 1
        fi
        
        echo "ğŸ‰ Deploy automÃ¡tico concluÃ­do com sucesso!"
